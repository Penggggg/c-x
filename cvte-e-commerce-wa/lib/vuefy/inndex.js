"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
function watch(ctx, obj) {
    Object.keys(obj).forEach(function (key) {
        defineReactive(ctx.data, key, ctx.data[key], function (value) {
            obj[key].call(ctx, value);
        });
    });
}
exports.watch = watch;
function computed(ctx, obj) {
    var keys = Object.keys(obj);
    var dataKeys = Object.keys(ctx.data);
    dataKeys.forEach(function (dataKey) {
        defineReactive(ctx.data, dataKey, ctx.data[dataKey]);
    });
    var firstComputedObj = keys.reduce(function (prev, next) {
        ctx.data.$target = function () {
            var _a;
            ctx.setData((_a = {}, _a[next] = obj[next].call(ctx), _a));
        };
        prev[next] = obj[next].call(ctx);
        ctx.data.$target = null;
        return prev;
    }, {});
    ctx.setData(firstComputedObj);
}
exports.computed = computed;
function defineReactive(data, key, val, fn) {
    var subs = data['$' + key] || [];
    Object.defineProperty(data, key, {
        configurable: true,
        enumerable: true,
        get: function () {
            if (data.$target) {
                subs.push(data.$target);
                data['$' + key] = subs;
            }
            return val;
        },
        set: function (newVal) {
            if (newVal === val)
                return;
            fn && fn(newVal);
            if (subs.length) {
                setTimeout(function () {
                    subs.forEach(function (sub) { return sub(); });
                }, 0);
            }
            val = newVal;
        },
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5uZGV4LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiaW5uZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsU0FBZ0IsS0FBSyxDQUFDLEdBQVEsRUFBRSxHQUFRO0lBQ3BDLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQUEsR0FBRztRQUMxQixjQUFjLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxVQUFTLEtBQVU7WUFDOUQsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUE7UUFDM0IsQ0FBQyxDQUFDLENBQUE7SUFDSixDQUFDLENBQUMsQ0FBQTtBQUNKLENBQUM7QUFOSCxzQkFNRztBQUVILFNBQWdCLFFBQVEsQ0FBQyxHQUFRLEVBQUUsR0FBUTtJQUN2QyxJQUFJLElBQUksR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFBO0lBQzNCLElBQUksUUFBUSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFBO0lBQ3BDLFFBQVEsQ0FBQyxPQUFPLENBQUMsVUFBQSxPQUFPO1FBQ3RCLGNBQWMsQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLE9BQU8sRUFBRSxHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUE7SUFDdEQsQ0FBQyxDQUFDLENBQUE7SUFDRixJQUFJLGdCQUFnQixHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsVUFBQyxJQUFTLEVBQUUsSUFBSTtRQUNqRCxHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sR0FBRzs7WUFDakIsR0FBRyxDQUFDLE9BQU8sV0FBRyxHQUFDLElBQUksSUFBRyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFHLENBQUE7UUFDOUMsQ0FBQyxDQUFBO1FBQ0QsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUE7UUFDaEMsR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFBO1FBQ3ZCLE9BQU8sSUFBSSxDQUFBO0lBQ2IsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFBO0lBQ04sR0FBRyxDQUFDLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFBO0FBQy9CLENBQUM7QUFmSCw0QkFlRztBQUVELFNBQVMsY0FBYyxDQUFDLElBQVMsRUFBRSxHQUFRLEVBQUUsR0FBUSxFQUFFLEVBQVE7SUFDN0QsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUE7SUFDaEMsTUFBTSxDQUFDLGNBQWMsQ0FBQyxJQUFJLEVBQUUsR0FBRyxFQUFFO1FBQy9CLFlBQVksRUFBRSxJQUFJO1FBQ2xCLFVBQVUsRUFBRSxJQUFJO1FBQ2hCLEdBQUcsRUFBRTtZQUNILElBQUksSUFBSSxDQUFDLE9BQU8sRUFBRTtnQkFDaEIsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUE7Z0JBQ3ZCLElBQUksQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFBO2FBQ3ZCO1lBQ0QsT0FBTyxHQUFHLENBQUE7UUFDWixDQUFDO1FBQ0QsR0FBRyxFQUFFLFVBQVMsTUFBTTtZQUNsQixJQUFJLE1BQU0sS0FBSyxHQUFHO2dCQUFFLE9BQU07WUFDMUIsRUFBRSxJQUFJLEVBQUUsQ0FBQyxNQUFNLENBQUMsQ0FBQTtZQUNoQixJQUFJLElBQUksQ0FBQyxNQUFNLEVBQUU7Z0JBRWYsVUFBVSxDQUFDO29CQUNULElBQUksQ0FBQyxPQUFPLENBQUMsVUFBQyxHQUFRLElBQUssT0FBQSxHQUFHLEVBQUUsRUFBTCxDQUFLLENBQUMsQ0FBQTtnQkFDbkMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFBO2FBQ047WUFDRCxHQUFHLEdBQUcsTUFBTSxDQUFBO1FBQ2QsQ0FBQztLQUNGLENBQUMsQ0FBQTtBQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJleHBvcnQgZnVuY3Rpb24gd2F0Y2goY3R4OiBhbnksIG9iajogYW55KSB7XG4gICAgT2JqZWN0LmtleXMob2JqKS5mb3JFYWNoKGtleSA9PiB7XG4gICAgICBkZWZpbmVSZWFjdGl2ZShjdHguZGF0YSwga2V5LCBjdHguZGF0YVtrZXldLCBmdW5jdGlvbih2YWx1ZTogYW55KSB7XG4gICAgICAgIG9ialtrZXldLmNhbGwoY3R4LCB2YWx1ZSlcbiAgICAgIH0pXG4gICAgfSlcbiAgfVxuICBcbmV4cG9ydCBmdW5jdGlvbiBjb21wdXRlZChjdHg6IGFueSwgb2JqOiBhbnkpIHtcbiAgICBsZXQga2V5cyA9IE9iamVjdC5rZXlzKG9iailcbiAgICBsZXQgZGF0YUtleXMgPSBPYmplY3Qua2V5cyhjdHguZGF0YSlcbiAgICBkYXRhS2V5cy5mb3JFYWNoKGRhdGFLZXkgPT4ge1xuICAgICAgZGVmaW5lUmVhY3RpdmUoY3R4LmRhdGEsIGRhdGFLZXksIGN0eC5kYXRhW2RhdGFLZXldKVxuICAgIH0pXG4gICAgbGV0IGZpcnN0Q29tcHV0ZWRPYmogPSBrZXlzLnJlZHVjZSgocHJldjogYW55LCBuZXh0KSA9PiB7XG4gICAgICBjdHguZGF0YS4kdGFyZ2V0ID0gZnVuY3Rpb24oKSB7XG4gICAgICAgIGN0eC5zZXREYXRhKHsgW25leHRdOiBvYmpbbmV4dF0uY2FsbChjdHgpIH0pXG4gICAgICB9XG4gICAgICBwcmV2W25leHRdID0gb2JqW25leHRdLmNhbGwoY3R4KVxuICAgICAgY3R4LmRhdGEuJHRhcmdldCA9IG51bGxcbiAgICAgIHJldHVybiBwcmV2XG4gICAgfSwge30pXG4gICAgY3R4LnNldERhdGEoZmlyc3RDb21wdXRlZE9iailcbiAgfVxuICBcbiAgZnVuY3Rpb24gZGVmaW5lUmVhY3RpdmUoZGF0YTogYW55LCBrZXk6IGFueSwgdmFsOiBhbnksIGZuPzogYW55KSB7XG4gICAgbGV0IHN1YnMgPSBkYXRhWyckJyArIGtleV0gfHwgW11cbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZGF0YSwga2V5LCB7XG4gICAgICBjb25maWd1cmFibGU6IHRydWUsXG4gICAgICBlbnVtZXJhYmxlOiB0cnVlLFxuICAgICAgZ2V0OiBmdW5jdGlvbigpIHtcbiAgICAgICAgaWYgKGRhdGEuJHRhcmdldCkge1xuICAgICAgICAgIHN1YnMucHVzaChkYXRhLiR0YXJnZXQpXG4gICAgICAgICAgZGF0YVsnJCcgKyBrZXldID0gc3Vic1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB2YWxcbiAgICAgIH0sXG4gICAgICBzZXQ6IGZ1bmN0aW9uKG5ld1ZhbCkge1xuICAgICAgICBpZiAobmV3VmFsID09PSB2YWwpIHJldHVyblxuICAgICAgICBmbiAmJiBmbihuZXdWYWwpXG4gICAgICAgIGlmIChzdWJzLmxlbmd0aCkge1xuICAgICAgICAgIC8vIOeUqCBzZXRUaW1lb3V0IOWboOS4uuatpOaXtiB0aGlzLmRhdGEg6L+Y5rKh5pu05pawXG4gICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICBzdWJzLmZvckVhY2goKHN1YjogYW55KSA9PiBzdWIoKSlcbiAgICAgICAgICB9LCAwKVxuICAgICAgICB9XG4gICAgICAgIHZhbCA9IG5ld1ZhbFxuICAgICAgfSxcbiAgICB9KVxuICB9XG4gIFxuIl19